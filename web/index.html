<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
</head>

{% set default_model = models[default_model] %}
{% set default_is_controllable = default_model.controllable %}
{% set default_is_multi_speaker = default_model.multi_speaker %}

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-8 order-md-1">
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            {% for control in controls %}
                            <label for="{{control.val}}" class="form-label">{{control.name}}</label>
                            <div class="d-flex" style="gap: 10px;">
                                <input autocomplete="off" type="range" class="form-range w-100 control-input" min="-1"
                                    max="1" step="0.01" id="{{control.val}}"
                                    oninput="this.nextElementSibling.value = this.value" {{"disabled" if not
                                    default_model.controllable}}>
                                <input autocomplete="off" readonly class="form-control flex-shrink-1 control-input"
                                    id="{{control.val}}-value" style="width:5em" {{"disabled" if not
                                    default_model.controllable}}>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-10">
                            <label for="model">Model:</label>
                            <select autocomplete="off" class="form-control" id="model">
                                {% for control_val, control in models.items() %}
                                <option label="{{control.name}}">{{control_val}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="voice">Voice:</label>
                            <select autocomplete="off" class="form-control voice-input" id="voice" {{"disabled" if not
                                default_model.multi_speaker}}>
                                {% for i in range(default_model.num_voices) %}
                                <option>{{i}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <label for="random-seed" class="form-label">Random Seed</label>
                            <div class="d-flex">
                                <input autocomplete="off" type="number" class="form-control form-inline"
                                    id="random-seed" placeholder="-1">
                                <button class="btn btn-secondary" id="save-seed" type="button" data-bs-toggle="tooltip"
                                    data-bs-placement="top" data-bs-title="Freeze current seed"
                                    onclick="this.previousElementSibling.value = randomSeed">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-save" viewBox="0 0 16 16">
                                        <path
                                            d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z" />
                                    </svg>
                                </button>
                                <button class="btn btn-success" type="button" data-bs-toggle="tooltip"
                                    data-bs-placement="top" data-bs-title="Reset to new random seed"
                                    onclick="this.previousElementSibling.previousElementSibling.value = ''; randomSeed = getRandomInt(MAX_RANDOM);">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-recycle" viewBox="0 0 16 16">
                                        <path
                                            d="M9.302 1.256a1.5 1.5 0 0 0-2.604 0l-1.704 2.98a.5.5 0 0 0 .869.497l1.703-2.981a.5.5 0 0 1 .868 0l2.54 4.444-1.256-.337a.5.5 0 1 0-.26.966l2.415.647a.5.5 0 0 0 .613-.353l.647-2.415a.5.5 0 1 0-.966-.259l-.333 1.242-2.532-4.431zM2.973 7.773l-1.255.337a.5.5 0 1 1-.26-.966l2.416-.647a.5.5 0 0 1 .612.353l.647 2.415a.5.5 0 0 1-.966.259l-.333-1.242-2.545 4.454a.5.5 0 0 0 .434.748H5a.5.5 0 0 1 0 1H1.723A1.5 1.5 0 0 1 .421 12.24l2.552-4.467zm10.89 1.463a.5.5 0 1 0-.868.496l1.716 3.004a.5.5 0 0 1-.434.748h-5.57l.647-.646a.5.5 0 1 0-.708-.707l-1.5 1.5a.498.498 0 0 0 0 .707l1.5 1.5a.5.5 0 1 0 .708-.707l-.647-.647h5.57a1.5 1.5 0 0 0 1.302-2.244l-1.716-3.004z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>



                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="tts-text-input" class="form-label">Text to speak</label>
                                <textarea autocomplete="off" class="form-control" id="tts-text-input"
                                    rows="4"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <input type="checkbox" checked autocomplete="off" class="form-checkbox control-input"
                                id="vocoder">
                            <label for="vocoder">Use vocoder</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary" id="generate" disabled autocomplete="off">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none;"
                                    id="generate-spinner"></span>
                                <span class="sr-only" id="generate-text">Generate</span>
                            </button>
                            <button type="submit" class="btn btn-secondary">Save</button>
                            <button type="submit" class="btn btn-secondary">Reset</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4 order-md-2 mb-4 d-flex align-items-center">
                <audio controls id="player">
                    <source id="audio-source">
                </audio>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script>const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))</script>
    <script>
        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        // Initial setup
        const MAX_RANDOM = 1000000000
        var randomSeed = getRandomInt(MAX_RANDOM);

        // Track whether the tool is currently in the process of generating a speech sample
        var is_generating = false;
        var is_empty = true;

        $(document).ready(function () {
            // User selects a new model from the dropdown
            $('#model').change(async function () {
                const config = await $.getJSON({ url: '/config', cache: true });
                const modelConfig = config['models'][$(this).val()];

                // Enable or disable controls as necessary
                $('.control-input').prop('disabled', !modelConfig['controllable']);
                $('#voice').prop('disabled', !modelConfig['multi_speaker']);

                // Alter the number of available voices to correspond with the model config
                $('#voice').empty()
                const newOptions = [...Array(modelConfig.num_voices).keys()].map((i) => new Option(i.toString(), i.toString()));
                newOptions.forEach(newOption => $('#voice').append(newOption))
            })

            // Disallow generation unless there is text in the text field
            $('#tts-text-input').on('input', function () {
                if ($(this).val().trim().length == 0) {
                    $('#generate').prop('disabled', true);
                    is_empty = true;
                } else {
                    is_empty = false;

                    if (!is_generating) {
                        $('#generate').prop('disabled', false);
                    }
                }

            })

            // Handle speech generation
            $('#generate').on("click", async function () {
                var formRandom = document.getElementById('random-seed').value;

                if (formRandom == "") {
                    randomSeed = getRandomInt(MAX_RANDOM);
                    formRandom = randomSeed;
                } else {
                    formRandom = parseInt(formRandom);
                    randomSeed = formRandom;
                }

                const output = {
                    pitch: parseFloat($('#pitch').val()),
                    pitch_range: parseFloat($('#pitch_range').val()),
                    intensity: parseFloat($('#intensity').val()),
                    nhr: parseFloat($('#nhr').val()),
                    rate: parseFloat($('#rate').val()),
                    model: $('#model').val(),
                    speaker: parseInt($('#voice').val()),
                    text: $('#tts-text-input').val(),
                    random_seed: formRandom,
                    vocoder: $('#vocoder').is(':checked')
                }

                const generateBtn = $('#generate');
                generateBtn.width(generateBtn.width());
                generateBtn.prop('disabled', true);
                generateBtn.children('#generate-spinner').show();
                generateBtn.children('#generate-text').hide();

                is_generating = true;

                result = await $.ajax({
                    type: "POST",
                    url: "/generate",
                    data: JSON.stringify(output),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                })

                generateBtn.children('#generate-spinner').hide();
                generateBtn.children('#generate-text').show();

                if (!is_empty) {
                    $('#generate').prop('disabled', false);
                }

                is_generating = false

                $('#audio-source').attr('src', result['filename']);
                console.log(result['filename'])
                $('#player')[0].load();
                $('#player')[0].play();

                console.log(output)
            });
        });
    </script>
</body>

</html>